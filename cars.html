<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cars | IOW Car Finder</title>

  <style>
    :root {
      --bg0: #f6f7f9;
      --bg1: #eef2f6;

      --card: #ffffff;
      --text: #0b1220;
      --muted: #667085;

      --accent: #e67e22;

      --stroke: rgba(17, 24, 39, .10);
      --strokeSoft: rgba(17, 24, 39, .08);

      --shadowSoft: 0 12px 40px rgba(0, 0, 0, .08);
      --shadowHover: 0 18px 55px rgba(0, 0, 0, .14);

      --radius: 18px;
      --radiusCard: 22px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--text);
      background:
        radial-gradient(900px 480px at 10% -10%, rgba(230, 126, 34, .10), transparent 60%),
        radial-gradient(900px 480px at 90% -10%, rgba(17, 24, 39, .06), transparent 60%),
        linear-gradient(180deg, var(--bg0) 0%, var(--bg1) 100%);
    }

    a {
      color: inherit;
      text-decoration: none;
    }

    /* ===== Header ===== */
    header {
      position: sticky;
      top: 0;
      z-index: 60;
      background: rgba(8, 10, 14, .78);
      color: #fff;
      border-bottom: 1px solid rgba(255, 255, 255, .08);
      backdrop-filter: blur(12px);
    }

    header .top {
      max-width: 1120px;
      margin: 0 auto;
      padding: 14px 18px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .brand {
      display: flex;
      flex-direction: column;
      line-height: 1.05;
    }

    .brand strong {
      font-size: 1.02rem;
      letter-spacing: .01em;
    }

    .brand span {
      font-size: .82rem;
      opacity: .78;
      margin-top: 2px;
    }

    header nav {
      display: flex;
      gap: 10px;
      align-items: center;
      font-weight: 850;
    }

    header nav a {
      padding: 8px 12px;
      border-radius: 999px;
      transition: background .15s ease, border-color .15s ease;
      border: 1px solid transparent;
    }

    header nav a:hover {
      background: rgba(255, 255, 255, .10);
      border-color: rgba(255, 255, 255, .12);
    }

    header nav a.active {
      background: rgba(255, 255, 255, .14);
      border: 1px solid rgba(255, 255, 255, .18);
    }

    /* ===== Intro ===== */
    .hero {
      max-width: 1120px;
      margin: 0 auto;
      padding: 22px 18px 10px;
      display: grid;
      gap: 8px;
    }

    .hero h1 {
      margin: 0;
      font-size: clamp(1.6rem, 2.6vw, 2.25rem);
      letter-spacing: -0.03em;
      font-weight: 950;
    }

    .hero p {
      margin: 0;
      color: var(--muted);
      font-size: 1rem;
      line-height: 1.5;
      max-width: 62ch;
    }

    main {
      max-width: 1120px;
      margin: 0 auto;
      padding: 12px 18px 28px;
    }

    /* ===== Sticky filters wrapper ===== */
    .filtersWrap {
      position: sticky;
      top: 64px;
      z-index: 55;
      margin-bottom: 16px;
    }

    .filters {
      background: rgba(255, 255, 255, .92);
      backdrop-filter: blur(12px);
      border: 1px solid var(--stroke);
      box-shadow: var(--shadowSoft);
      border-radius: 22px;
      padding: 14px;
    }

    /* Top row */
    .filtersTop {
      display: grid;
      grid-template-columns: 1.4fr 1fr auto;
      gap: 10px;
      align-items: center;
    }

    /* Advanced row */
    .filtersAdvanced {
      display: grid;
      grid-template-columns: 0.9fr 0.9fr 0.9fr auto;
      gap: 10px;
      align-items: center;
      margin-top: 10px;
    }

    .filters input,
    .filters select {
      width: 100%;
      padding: 11px 12px;
      border-radius: 14px;
      border: 1px solid rgba(17, 24, 39, .12);
      font-size: .95rem;
      outline: none;
      background: rgba(255, 255, 255, .96);
      transition: box-shadow .15s ease, border-color .15s ease, transform .15s ease;
    }

    .filters input:focus,
    .filters select:focus {
      border-color: rgba(230, 126, 34, .45);
      box-shadow: 0 0 0 4px rgba(230, 126, 34, .15);
    }

    .btnRow {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      align-items: center;
    }

    .btn {
      border: 1px solid rgba(17, 24, 39, .10);
      border-radius: 14px;
      padding: 11px 14px;
      cursor: pointer;
      font-weight: 950;
      background: #ffffff;
      color: #111827;
      box-shadow: 0 6px 18px rgba(0, 0, 0, .07);
      transition: transform .15s ease, box-shadow .15s ease, opacity .15s ease;
      white-space: nowrap;
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 24px rgba(0, 0, 0, .10);
    }

    .btn.primary {
      background: var(--accent);
      border-color: rgba(230, 126, 34, .55);
      color: #fff;
      box-shadow: 0 10px 24px rgba(230, 126, 34, .22);
    }

    .btn.primary:hover {
      box-shadow: 0 14px 30px rgba(230, 126, 34, .26);
    }

    .btn.ghost {
      background: rgba(17, 24, 39, .04);
      border: 1px solid rgba(17, 24, 39, .12);
      box-shadow: none;
    }

    .hint {
      grid-column: 1 / -1;
      color: var(--muted);
      font-size: .9rem;
      margin-top: 6px;
      padding-left: 2px;
    }

    /* Desktop: show advanced always, hide toggle button */
    @media (min-width: 981px) {
      #toggleFilters {
        display: none;
      }
    }

    /* Tablet/mobile: compact + toggle */
    @media (max-width: 980px) {
      .filtersWrap {
        top: 60px;
      }

      .filtersTop {
        grid-template-columns: 1fr 1fr auto;
      }

      .filtersAdvanced {
        display: none;
        grid-template-columns: 1fr 1fr;
      }

      #filtersBar.is-open .filtersAdvanced {
        display: grid;
      }
    }

    @media (max-width: 600px) {
      main {
        padding: 10px 14px 22px;
      }

      .hero {
        padding: 18px 14px 8px;
      }

      .filtersWrap {
        top: 58px;
      }

      .filters {
        padding: 12px;
        border-radius: 18px;
      }

      .filtersTop {
        grid-template-columns: 1fr;
      }

      .filtersAdvanced {
        grid-template-columns: 1fr;
      }

      .btnRow {
        display: grid;
        grid-template-columns: 1fr 1fr;
      }

      .btn {
        width: 100%;
        box-shadow: none;
      }

      .btn:not(.primary) {
        background: transparent;
      }
    }

    /* ===== Status ===== */
    .status {
      background: var(--card);
      padding: 14px;
      border-radius: 16px;
      border: 1px solid var(--strokeSoft);
      box-shadow: 0 2px 10px rgba(0, 0, 0, .06);
      color: var(--muted);
    }

    /* ===== Cards grid ===== */
    .grid {
      margin-top: 14px;
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 16px;
    }

    @media (max-width: 980px) {
      .grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (max-width: 600px) {
      .grid {
        grid-template-columns: 1fr;
        gap: 14px;
      }
    }

    /* ===== Car card ===== */
    .carCard {
      background: var(--card);
      border-radius: var(--radiusCard);
      box-shadow: var(--shadowSoft);
      border: 1px solid var(--strokeSoft);
      overflow: hidden;
      display: block;
      position: relative;
      transition: transform .15s ease, box-shadow .15s ease;
    }

    .carCard:hover {
      transform: translateY(-3px);
      box-shadow: var(--shadowHover);
    }

    .imgWrap {
      position: relative;
      background: #e9edf2;
    }

    .carImg {
      width: 100%;
      height: 230px;
      object-fit: cover;
      display: block;
      background: #e9edf2;
    }

    /* Cinematic fade overlay */
    .imgWrap::after {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(180deg, rgba(0, 0, 0, 0) 55%, rgba(0, 0, 0, .22) 100%);
      pointer-events: none;
    }

    @media (max-width: 600px) {
      .carImg {
        height: 250px;
      }
    }

    .soldBadge {
      position: absolute;
      top: 12px;
      left: 12px;
      padding: 7px 10px;
      border-radius: 999px;
      background: rgba(0, 0, 0, .78);
      color: #fff;
      font-weight: 1000;
      font-size: .84rem;
      letter-spacing: .2px;
      border: 1px solid rgba(255, 255, 255, .16);
    }

    .body {
      padding: 16px;
    }

    .name {
      margin: 0;
      font-size: 1.14rem;
      font-weight: 950;
      letter-spacing: -0.01em;
      line-height: 1.2;
    }

    .price {
      margin: 10px 0 10px;
      font-size: 1.45rem;
      font-weight: 1000;
      color: #0b1220;
    }

    /* ===== Spec chips ===== */
    .specGrid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }

    .specGrid.compact {
      gap: 8px;
      margin-top: 10px;
    }

    .spec {
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(17, 24, 39, .03);
      border: 1px solid rgba(17, 24, 39, .08);
      min-width: 0;
    }

    .specLabel {
      font-size: .74rem;
      color: rgba(17, 24, 39, .55);
      margin-bottom: 3px;
      letter-spacing: .02em;
    }

    .specValue {
      font-size: .98rem;
      font-weight: 950;
      color: #0b1220;
      line-height: 1.12;
      word-break: break-word;
    }

    @media (max-width: 360px) {
      .specGrid {
        grid-template-columns: 1fr;
      }
    }

    .mutedLine {
      margin-top: 12px;
      padding-top: 10px;
      border-top: 1px solid rgba(17, 24, 39, .08);
      color: var(--muted);
      font-size: .92rem;
    }

    .spacer {
      height: 22px;
    }
  </style>
</head>

<body>
  <header>
    <div class="top">
      <a class="brand" href="/">
        <strong>IOW Car Finder</strong>
        <span>Isle of Wight • Used cars • Local garages</span>
      </a>

      <nav>
        <a href="/" aria-label="Home">Home</a>
        <a class="active" href="/cars-page" aria-label="Cars">Cars</a>
      </nav>
    </div>
  </header>

  <section class="hero">
    <h1>Cars</h1>
    <p>Browse listings from local Isle of Wight garages. Filter by fuel, gear, price and more.</p>
  </section>

  <main>
    <div class="filtersWrap">
      <div class="filters" id="filtersBar">
        <div class="filtersTop">
          <input id="searchBox" type="text" placeholder="Search cars (e.g. Golf, diesel, auto)…" />

          <select id="sortBox">
            <option value="recent">Sort: Recently updated</option>
            <option value="price-asc">Price: Low → High</option>
            <option value="price-desc">Price: High → Low</option>
            <option value="year-desc">Year: Newest</option>
            <option value="mileage-asc">Mileage: Lowest</option>
          </select>

          <button id="toggleFilters" class="btn ghost" type="button" aria-expanded="false">
            Filters
          </button>
        </div>

        <div class="filtersAdvanced">
          <select id="fuelBox">
            <option value="">Fuel (All)</option>
          </select>

          <select id="gearBox">
            <option value="">Gear (All)</option>
          </select>

          <select id="maxPriceBox">
            <option value="">Max price</option>
            <option value="5000">£5,000</option>
            <option value="7500">£7,500</option>
            <option value="10000">£10,000</option>
            <option value="15000">£15,000</option>
            <option value="20000">£20,000</option>
            <option value="30000">£30,000</option>
            <option value="50000">£50,000</option>
          </select>

          <div class="btnRow">
            <button id="resetBtn" class="btn" type="button">Reset</button>
            <button id="applyBtn" class="btn primary" type="button">Apply</button>
          </div>

          <div id="countLine" class="hint">Loading…</div>
        </div>
      </div>
    </div>

    <div id="status" class="status">Loading cars…</div>
    <div id="grid" class="grid" style="display:none;"></div>

    <div class="spacer"></div>
  </main>

  <script>
    function money(n) {
      try { return "£" + Number(n).toLocaleString("en-GB"); }
      catch { return "£" + (n ?? ""); }
    }

    function miles(n) {
      const num = Number(n);
      if (!Number.isFinite(num)) return "";
      return num.toLocaleString("en-GB") + " miles";
    }

    function pickPhoto(car) {
      if (Array.isArray(car.photos) && car.photos.length) return car.photos[0];
      if (car.photo) return car.photo;
      return "/images/hero.png";
    }

    function safeText(s) { return String(s ?? "").trim(); }
    function norm(s) { return safeText(s).toLowerCase(); }

    function uniqueSorted(arr) {
      const set = new Set(arr.filter(Boolean));
      return [...set].sort((a, b) => a.localeCompare(b, "en", { sensitivity: "base" }));
    }

    function escapeHtml(t) {
      return String(t ?? "").replace(/[&<>"']/g, ch => ({
        "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;"
      }[ch]));
    }

    function escapeAttr(t) {
      return escapeHtml(t).replace(/"/g, "&quot;");
    }

    async function fetchCars() {
      const tryUrls = ["/cars", "/cars-data"];
      for (const url of tryUrls) {
        try {
          const res = await fetch(url, { cache: "no-store" });
          if (!res.ok) continue;
          const data = await res.json();
          if (Array.isArray(data)) return data;
        } catch { }
      }
      return null;
    }

    let ALL = [];

    function fillDropdowns(cars) {
      const fuelBox = document.getElementById("fuelBox");
      const gearBox = document.getElementById("gearBox");

      const fuels = uniqueSorted(cars.map(c => safeText(c.fuel)));
      const gears = uniqueSorted(cars.map(c => safeText(c.transmission)));

      fuelBox.innerHTML =
        `<option value="">Fuel (All)</option>` +
        fuels.map(f => `<option value="${escapeAttr(f)}">${escapeHtml(f)}</option>`).join("");

      gearBox.innerHTML =
        `<option value="">Gear (All)</option>` +
        gears.map(g => `<option value="${escapeAttr(g)}">${escapeHtml(g)}</option>`).join("");
    }

    function applyFilters() {
      const search = norm(document.getElementById("searchBox").value);
      const sort = document.getElementById("sortBox").value;
      const fuel = norm(document.getElementById("fuelBox").value);
      const gear = norm(document.getElementById("gearBox").value);
      const maxPrice = Number(document.getElementById("maxPriceBox").value || 0);

      let filtered = [...ALL];

      if (search) {
        filtered = filtered.filter(c => {
          const hay = [c.name, c.fuel, c.transmission, c.engine, c.colour, c.garageId]
            .map(norm).join(" ");
          return hay.includes(search);
        });
      }

      if (fuel) filtered = filtered.filter(c => norm(c.fuel) === fuel);
      if (gear) filtered = filtered.filter(c => norm(c.transmission) === gear);
      if (maxPrice > 0) filtered = filtered.filter(c => Number(c.price) <= maxPrice);

      if (sort === "price-asc") filtered.sort((a, b) => (Number(a.price) || 0) - (Number(b.price) || 0));
      else if (sort === "price-desc") filtered.sort((a, b) => (Number(b.price) || 0) - (Number(a.price) || 0));
      else if (sort === "year-desc") filtered.sort((a, b) => (Number(b.year) || 0) - (Number(a.year) || 0));
      else if (sort === "mileage-asc") filtered.sort((a, b) => (Number(a.mileage) || 0) - (Number(b.mileage) || 0));
      else {
        filtered.sort((a, b) => {
          const ta = new Date(a.updatedAt || 0).getTime() || 0;
          const tb = new Date(b.updatedAt || 0).getTime() || 0;
          return tb - ta;
        });
      }

      renderCars(filtered);

      document.getElementById("countLine").textContent =
        `Showing ${filtered.length} of ${ALL.length} cars.`;
    }

    function renderCars(cars) {
      const status = document.getElementById("status");
      const grid = document.getElementById("grid");

      if (!Array.isArray(cars) || cars.length === 0) {
        grid.style.display = "none";
        status.style.display = "block";
        status.textContent = "No cars match your filters.";
        return;
      }

      status.style.display = "none";
      grid.style.display = "grid";
      grid.innerHTML = "";

      for (const car of cars) {
        const name = safeText(car.name) || "Car";
        const href = "/car?name=" + encodeURIComponent(name);

        const year = safeText(car.year);
        const mi = miles(car.mileage);

        const a = document.createElement("a");
        a.className = "carCard";
        a.href = href;

        a.innerHTML = `
          <div class="imgWrap">
            <img class="carImg" src="${escapeAttr(pickPhoto(car))}" alt="${escapeHtml(name)}"
                 onerror="this.src='/images/hero.png'">
            ${car.sold ? `<div class="soldBadge">SOLD</div>` : ``}
          </div>

          <div class="body">
            <h2 class="name">${escapeHtml(name)}</h2>
            <div class="price">${escapeHtml(money(car.price))}</div>

            <div class="specGrid compact">
              ${year ? `
                <div class="spec">
                  <div class="specLabel">Year</div>
                  <div class="specValue">${escapeHtml(year)}</div>
                </div>` : ``}

              ${mi ? `
                <div class="spec">
                  <div class="specLabel">Mileage</div>
                  <div class="specValue">${escapeHtml(mi)}</div>
                </div>` : ``}
            </div>

            ${car.garageId ? `<div class="mutedLine">Garage: ${escapeHtml(safeText(car.garageId))}</div>` : ``}
          </div>
        `;

        grid.appendChild(a);
      }
    }

    function resetFilters() {
      document.getElementById("searchBox").value = "";
      document.getElementById("sortBox").value = "recent";
      document.getElementById("fuelBox").value = "";
      document.getElementById("gearBox").value = "";
      document.getElementById("maxPriceBox").value = "";
      applyFilters();
    }

    (async function init() {
      const status = document.getElementById("status");
      const countLine = document.getElementById("countLine");

      const cars = await fetchCars();
      if (!cars) {
        status.textContent = "Could not load cars.";
        countLine.textContent = "Could not load.";
        return;
      }

      ALL = cars;

      fillDropdowns(ALL);
      applyFilters();

      // Toggle advanced filters (mobile)
      const filtersBar = document.getElementById("filtersBar");
      const toggleBtn = document.getElementById("toggleFilters");

      if (toggleBtn && filtersBar) {
        toggleBtn.addEventListener("click", () => {
          const open = filtersBar.classList.toggle("is-open");
          toggleBtn.setAttribute("aria-expanded", open ? "true" : "false");
          toggleBtn.textContent = open ? "Close filters" : "Filters";
        });
      }

      // UX: Enter applies, Escape closes filters (mobile)
      document.addEventListener("keydown", (e) => {
        if (e.key === "Enter") applyFilters();
        if (e.key === "Escape" && filtersBar?.classList.contains("is-open")) {
          filtersBar.classList.remove("is-open");
          if (toggleBtn) {
            toggleBtn.setAttribute("aria-expanded", "false");
            toggleBtn.textContent = "Filters";
          }
        }
      });

      document.getElementById("searchBox").addEventListener("input", applyFilters);
      document.getElementById("sortBox").addEventListener("change", applyFilters);

      document.getElementById("applyBtn").addEventListener("click", () => {
        applyFilters();
        // Mobile: close after apply
        if (window.matchMedia("(max-width: 980px)").matches && filtersBar?.classList.contains("is-open")) {
          filtersBar.classList.remove("is-open");
          if (toggleBtn) {
            toggleBtn.setAttribute("aria-expanded", "false");
            toggleBtn.textContent = "Filters";
          }
        }
      });

      document.getElementById("resetBtn").addEventListener("click", resetFilters);

      document.getElementById("fuelBox").addEventListener("change", applyFilters);
      document.getElementById("gearBox").addEventListener("change", applyFilters);
      document.getElementById("maxPriceBox").addEventListener("change", applyFilters);
    })();
  </script>
</body>

</html>